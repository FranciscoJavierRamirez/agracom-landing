---
// Agracom Internacional S.A. - Header Component
// Navegación principal con logo, menú y cambio de idioma

import type { Locale } from '../../types/global';
import { createTranslator, getLocalizedURL } from '../../utils/i18n';

export interface Props {
  currentLang: Locale;
  currentRegion?: string;
  transparent?: boolean;
  class?: string;
}

const { 
  currentLang, 
  currentRegion, 
  transparent = false,
  class: className = ''
} = Astro.props;

// Load translations
const { common } = await createTranslator(currentLang);

// Navigation items with dynamic IDs based on language
const navigation = [
  { 
    key: 'products', 
    href: currentLang === 'es' ? '#productos' : '#products' 
  },
  { 
    key: 'certifications', 
    href: currentLang === 'es' ? '#certificaciones' : '#certifications' 
  },
  { 
    key: 'regions', 
    href: currentLang === 'es' ? '#regiones' : '#regions' 
  },
  { 
    key: 'contact', 
    href: currentLang === 'es' ? '#contacto' : '#contact' 
  }
];

// Resolve navigation labels once
const navigationWithLabels = await Promise.all(
  navigation.map(async (item) => ({
    ...item,
    label: await common(`navigation.${item.key}`)
  }))
);

// Resolve CTA label
const ctaLabel = await common('cta.inquire');

// Get alternate language URL
// Alternate language functionality handled via URL parameters
---

<header 
  class={`sticky top-0 z-50 transition-all duration-300 ${
    transparent 
      ? 'bg-white bg-opacity-95 backdrop-blur-lg shadow-lg border-b border-neutral-100' 
      : 'bg-white shadow-lg border-b border-neutral-200'
  } ${className}`}
  role="banner"
>
  <div class="container mx-auto px-4 lg:px-6">
    <div class="flex items-center justify-between py-3 lg:py-4">
      
      <!-- Logo and Brand - Reorganizado -->
      <div class="flex items-center group">
        <a 
          href={getLocalizedURL('/', currentLang)}
          class="flex items-center space-x-3 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-opacity-50 rounded-xl p-2 -ml-2 transition-all duration-200 hover:bg-neutral-50"
          aria-label={`${currentLang === 'es' ? 'Ir al inicio' : 'Go to homepage'}`}
        >
          <!-- Logo más prominente -->
          <div class="w-12 h-12 lg:w-14 lg:h-14 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
            <img 
              src="/images/agracom-logo.svg" 
              alt="AgraCom Internacional Logo" 
              class="w-full h-full object-contain drop-shadow-sm"
              loading="eager"
            />
          </div>
          
          <!-- Brand Text simplificado -->
          <div class="hidden md:block">
            <h1 class="text-xl lg:text-2xl font-bold text-neutral-900 group-hover:text-primary transition-colors duration-200 leading-tight">
              Agracom Internacional
            </h1>
            <p class="text-sm text-neutral-500 font-medium hidden lg:block">
              {currentLang === 'es' ? 'Exportadores Premium' : 'Premium Exporters'}
            </p>
          </div>
        </a>
      </div>

      <!-- Desktop Navigation - Mejorado y Corregido -->
      <nav class="hidden lg:flex items-center space-x-2" role="navigation" aria-label="Main navigation">
        {navigationWithLabels.map((item) => (
          <a
            href={item.href}
            class="relative px-4 py-2 text-neutral-700 hover:text-primary font-semibold text-sm transition-all duration-200 rounded-lg hover:bg-primary hover:bg-opacity-10 group nav-link"
            data-nav-item
            data-nav-text={item.key}
          >
            <span class="relative z-10" data-nav-text={item.key}>{item.label}</span>
            <span class="absolute bottom-1 left-1/2 transform -translate-x-1/2 w-0 h-0.5 bg-primary transition-all duration-300 group-hover:w-6 rounded-full"></span>
          </a>
        ))}
      </nav>

      <!-- Right Section: Actions - Reorganizado -->
      <div class="flex items-center space-x-3">
        
        <!-- CTA Button - Más prominente -->
        <a 
          href={currentLang === 'es' ? '#contacto' : '#contact'}
          class="hidden md:inline-flex items-center px-5 py-2.5 bg-gradient-to-r from-primary to-primary-600 text-white text-sm font-semibold rounded-lg hover:from-primary-600 hover:to-primary-700 transition-all duration-200 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50"
        >
          <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
          </svg>
          {await common('cta.inquire')}
        </a>

        <!-- Language Switcher - Rediseñado -->
        <div class="flex items-center bg-neutral-100 rounded-lg p-1 border border-neutral-200">
                  <button 
          data-lang-btn="es"
          class="px-3 py-1.5 rounded-md text-xs font-bold transition-all duration-200 bg-primary text-white shadow-sm scale-105"
          aria-label="Página en español"
        >
          ES
        </button>
        <div class="w-px h-4 bg-neutral-300 mx-1"></div>
        <button 
          data-lang-btn="en"
          class="px-3 py-1.5 rounded-md text-xs font-bold transition-all duration-200 text-neutral-500 hover:text-neutral-700 hover:bg-white"
          aria-label="Switch to English"
        >
          EN
        </button>
        </div>

        <!-- Mobile Menu Button - Mejorado -->
        <button
          type="button"
          class="lg:hidden p-2.5 text-neutral-600 hover:text-primary hover:bg-neutral-100 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-30 rounded-lg transition-all duration-200"
          aria-label={currentLang === 'es' ? 'Abrir menú' : 'Open menu'}
          data-mobile-menu-trigger
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation Menu - Rediseñado -->
    <div 
      class="lg:hidden hidden bg-white border-t border-neutral-200 shadow-lg"
      data-mobile-menu
      role="navigation"
      aria-label="Mobile navigation"
    >
      <div class="px-4 py-6 space-y-2">
        {navigationWithLabels.map((item) => (
          <a
            href={item.href}
            class="flex items-center justify-between py-3 px-4 text-neutral-800 hover:text-primary hover:bg-primary hover:bg-opacity-10 font-semibold rounded-lg transition-all duration-200 group mobile-nav-link"
            data-mobile-menu-item
            data-nav-text={item.key}
          >
            <span class="text-base font-medium" data-nav-text={item.key}>{item.label}</span>
            <svg class="w-4 h-4 text-neutral-400 group-hover:text-primary transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        ))}
        
        <!-- Mobile CTA - Prominente -->
        <div class="pt-6 border-t border-neutral-200">
          <a 
            href={currentLang === 'es' ? '#contacto' : '#contact'}
            class="flex items-center justify-center w-full py-4 bg-gradient-to-r from-primary to-primary-600 text-white font-bold rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 transform hover:-translate-y-0.5"
          >
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
            </svg>
            {ctaLabel}
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Region Indicator (if region is set) -->
  {currentRegion && (
    <div class="bg-gradient-to-r from-accent from-opacity-10 to-accent to-opacity-5 border-b border-accent border-opacity-20" role="complementary" aria-label={currentLang === 'es' ? 'Información de región' : 'Region information'}>
      <div class="container mx-auto px-4 py-3">
        <div class="flex items-center justify-center text-sm">
          <svg class="w-4 h-4 mr-2 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span class="font-semibold text-accent-dark">
            {currentLang === 'es' ? 'Región seleccionada:' : 'Selected region:'} 
          </span>
          <span class="ml-2 px-2 py-1 bg-accent bg-opacity-20 text-accent-dark font-medium rounded-full text-xs">
            {currentRegion === 'us-east' && (currentLang === 'es' ? 'Costa Este EE.UU.' : 'US East Coast')}
            {currentRegion === 'mediterranean' && (currentLang === 'es' ? 'Mediterráneo' : 'Mediterranean')}
            {currentRegion === 'middle-east' && (currentLang === 'es' ? 'Medio Oriente' : 'Middle East')}
          </span>
        </div>
      </div>
    </div>
  )}
</header>

<!-- Enhanced Mobile Menu JavaScript -->
<script>
  // Mobile menu functionality
  document.addEventListener('DOMContentLoaded', function() {
    const menuTrigger = document.querySelector('[data-mobile-menu-trigger]');
    const mobileMenu = document.querySelector('[data-mobile-menu]');
    const menuItems = document.querySelectorAll('[data-mobile-menu-item]');
    
    if (menuTrigger && mobileMenu) {
      // Toggle mobile menu
      menuTrigger.addEventListener('click', function() {
        const isHidden = mobileMenu.classList.contains('hidden');
        
        if (isHidden) {
          mobileMenu.classList.remove('hidden');
          menuTrigger.setAttribute('aria-expanded', 'true');
          document.body.style.overflow = 'hidden'; // Prevenir scroll
          menuTrigger.classList.add('bg-neutral-100');
          // Change icon to X
          menuTrigger.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
            </svg>
          `;
        } else {
          mobileMenu.classList.add('hidden');
          menuTrigger.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = ''; // Restaurar scroll
          menuTrigger.classList.remove('bg-neutral-100');
          // Change icon back to hamburger
          menuTrigger.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          `;
        }
      });
      
      // Close menu when clicking on menu items
      menuItems.forEach(item => {
        item.addEventListener('click', function() {
          mobileMenu.classList.add('hidden');
          menuTrigger.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = ''; // Restaurar scroll
          menuTrigger.classList.remove('bg-neutral-100');
          menuTrigger.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          `;
        });
      });
      
      // Close menu on ESC key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !mobileMenu.classList.contains('hidden')) {
          mobileMenu.classList.add('hidden');
          menuTrigger.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = ''; // Restaurar scroll
          menuTrigger.classList.remove('bg-neutral-100');
          menuTrigger.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          `;
          (menuTrigger as HTMLElement).focus();
        }
      });
    }
  });
  
  // Enhanced smooth scrolling and active section detection
  document.addEventListener('DOMContentLoaded', function() {
    const anchorLinks = document.querySelectorAll('a[href^="#"]');
    const navItems = document.querySelectorAll('[data-nav-item]');
    const header = document.querySelector('header') as HTMLElement;
    const headerHeight = header ? header.offsetHeight : 80;
    
    // Smooth scrolling for anchor links
    anchorLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        const targetId = (e.target as HTMLAnchorElement).getAttribute('href');
        const targetElement = targetId ? document.querySelector(targetId) : null;
        
        if (targetElement) {
          e.preventDefault();
          const targetPosition = (targetElement as HTMLElement).offsetTop - headerHeight - 20;
          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });
        }
      });
    });
    
    // Active section detection
    function updateActiveNavItem() {
      const scrollPosition = window.scrollY + headerHeight + 100;
      const sections = document.querySelectorAll('section[id]');
      
      let activeSection = '';
      sections.forEach(section => {
        const sectionElement = section as HTMLElement;
        const sectionTop = sectionElement.offsetTop;
        const sectionHeight = sectionElement.offsetHeight;
        
        if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
          activeSection = section.getAttribute('id') || '';
        }
      });
      
      // Update nav items
      navItems.forEach(item => {
        const href = item.getAttribute('href');
        if (href === `#${activeSection}`) {
          item.classList.add('text-primary', 'bg-primary', 'bg-opacity-10');
        } else {
          item.classList.remove('text-primary', 'bg-primary', 'bg-opacity-10');
        }
      });
    }
    
    // Throttled scroll listener
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateActiveNavItem();
          ticking = false;
        });
        ticking = true;
      }
    });
  });
</script>

<style>
  /* Enhanced Header Styles */
  header {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  
  /* Logo hover effect mejorado */
  .group:hover .w-12,
  .group:hover .lg\:w-14 {
    transform: scale(1.1) rotate(2deg);
    filter: drop-shadow(0 4px 8px rgba(21, 101, 192, 0.3));
  }
  
  /* Navigation enhanced styles - Corregido */
  .nav-link {
    position: relative;
    overflow: hidden;
    color: var(--color-neutral-700) !important;
    font-weight: 600;
    z-index: 1;
  }
  
  .nav-link:hover {
    color: var(--color-primary) !important;
    background-color: rgba(21, 101, 192, 0.1);
  }
  
  .nav-link span {
    position: relative;
    z-index: 2;
    color: inherit;
  }
  
  .mobile-nav-link {
    color: var(--color-neutral-800) !important;
    font-weight: 600;
  }
  
  .mobile-nav-link:hover {
    color: var(--color-primary) !important;
    background-color: rgba(21, 101, 192, 0.1);
  }
  
  .mobile-nav-link span {
    color: inherit;
  }
  
  /* Mobile menu animation mejorada */
  [data-mobile-menu] {
    animation: slideDownFade 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    transform-origin: top;
  }
  
  @keyframes slideDownFade {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  /* CTA button gradiente mejorado */
  .bg-gradient-to-r {
    background-size: 200% 100%;
    animation: shimmer 3s infinite;
  }
  
  @keyframes shimmer {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
  
  /* Header scroll effect */
  @media (min-width: 1024px) {
    header.scrolled {
      padding-top: 0.5rem;
      padding-bottom: 0.5rem;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
  }
  
  /* Focus styles mejorados */
  button:focus-visible,
  a:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
    border-radius: 0.5rem;
  }
  
  /* Smooth transitions para todos los elementos interactivos */
  button, a, [data-nav-item] {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Language switcher hover effect */
  .bg-neutral-100 a:hover {
    transform: translateY(-1px);
  }
  
  /* Ensure text visibility - Override any conflicting styles */
  header nav a,
  header [data-nav-item],
  header .nav-link,
  header .mobile-nav-link {
    text-decoration: none !important;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  header nav a span,
  header [data-nav-item] span,
  header .nav-link span,
  header .mobile-nav-link span {
    opacity: 1 !important;
    visibility: visible !important;
    color: inherit !important;
  }
  
  /* Brand text visibility */
  header h1,
  header p {
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  /* Mobile menu text visibility */
  [data-mobile-menu] a,
  [data-mobile-menu] span {
    opacity: 1 !important;
    visibility: visible !important;
    color: inherit !important;
  }
</style>