---
// Agracom Internacional S.A. - Header Component
// Navegación principal con logo, menú y cambio de idioma

import type { Locale } from '../../types/global';
import { getLocalizedURL } from '../../utils/i18n';
import LanguageSwitcher from '../ui/LanguageSwitcher.astro';

export interface Props {
  currentLang: Locale;
  currentRegion?: string;
  transparent?: boolean;
  class?: string;
}

const { 
  currentLang, 
  currentRegion, 
  transparent = false,
  class: className = ''
} = Astro.props;

// Load header configuration (content) from JSON per locale
const headerConfigModule = await import(`../../data/i18n/${currentLang}/header.json`);
const headerConfig = headerConfigModule.default as any;
const navItems: Array<{ key: string; href: string; label: string }> = headerConfig.nav || [];
const cta = headerConfig.cta || { text: '', href: '#' };
const aria = headerConfig.aria || { home: 'Home', open_menu: 'Open menu', region_info: 'Region information' };
const regionLabels: Record<string, string> = headerConfig.regionLabels || {};
const options = headerConfig.options || { showRegionIndicator: true };
---

<header 
  class={`sticky top-0 z-50 transition-all duration-300 ${
    transparent 
      ? 'bg-white bg-opacity-95 backdrop-blur-lg shadow-lg border-b border-neutral-100' 
      : 'bg-white shadow-lg border-b border-neutral-200'
  } ${className}`}
  role="banner"
>
  <div class="container">
    <div class="flex items-center justify-between gap-x-6 py-3 lg:py-4">
      
      <!-- Logo and Brand - Reorganizado -->
      <div class="flex items-center group">
        <a 
          href={getLocalizedURL('/', currentLang)}
          class="flex items-center space-x-4 focus:outline-none focus:ring-2 focus:ring-accent focus:ring-opacity-50 rounded-2xl p-2 transition-all duration-200 hover:bg-neutral-50"
          aria-label={`${currentLang === 'es' ? 'Ir al inicio' : 'Go to homepage'}`}
        >
          <!-- Logo más prominente -->
          <div class="h-12 lg:h-14 flex items-center">
            <img 
              src="/images/agracom-logo.svg?v=1" 
              alt="AgraCom Internacional Logo" 
              class="block h-full w-auto object-contain"
              loading="eager"
            />
          </div>
          
          
        </a>
      </div>

      <!-- Desktop Navigation - Mejorado y Corregido -->
      <nav class="hidden lg:flex items-center gap-x-4" role="navigation" aria-label="Main navigation">
        {navItems.map((item) => (
          <a
            href={item.href}
            class="relative px-3 py-2 text-neutral-800 hover:text-primary font-semibold text-[15px] transition-all duration-200 rounded-lg hover:bg-primary hover:bg-opacity-10 group nav-link"
            data-nav-item
            data-nav-text={item.key}
            aria-current="false"
          >
            <span class="relative z-10" data-nav-text={item.key}>{item.label}</span>
            <span class="absolute bottom-1 left-3 right-3 mx-auto w-0 h-0.5 bg-primary transition-all duration-300 group-hover:w-10 rounded-full"></span>
          </a>
        ))}
      </nav>

      <!-- Right Section: Actions - Reorganizado -->
      <div class="flex items-center gap-x-3 lg:ml-6">
        
        <!-- CTA Button - Más prominente -->
        {cta?.text && (
          <a 
            href={cta.href}
            class="hidden md:inline-flex items-center px-4 py-2.5 bg-primary text-white text-[15px] font-semibold rounded-lg hover:bg-primary-600 transition-colors shadow-sm hover:shadow-md focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50"
          >
            {cta.text}
          </a>
        )}

        <!-- Language Switcher Component -->
        <LanguageSwitcher variant="header" currentLang={currentLang} />

        <!-- Mobile Menu Button - Mejorado -->
        <button
          type="button"
          class="lg:hidden p-2.5 text-neutral-600 hover:text-primary hover:bg-neutral-100 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-30 rounded-lg transition-all duration-200"
          aria-label={aria.open_menu}
          data-mobile-menu-trigger
        >
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Mobile Navigation Menu - Rediseñado -->
    <div 
      class="lg:hidden hidden bg-white border-t border-neutral-200 shadow-lg"
      data-mobile-menu
      role="navigation"
      aria-label="Mobile navigation"
    >
      <div class="px-4 py-6 space-y-2">
        {navItems.map((item) => (
          <a
            href={item.href}
            class="flex items-center justify-between py-3 px-4 text-neutral-800 hover:text-primary hover:bg-primary hover:bg-opacity-10 font-semibold rounded-lg transition-all duration-200 group mobile-nav-link"
            data-mobile-menu-item
            data-nav-text={item.key}
          >
            <span class="text-base font-medium" data-nav-text={item.key}>{item.label}</span>
            <svg class="w-4 h-4 text-neutral-400 group-hover:text-primary transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </a>
        ))}
        
        <!-- Mobile CTA - Prominente -->
        <div class="pt-6 border-t border-neutral-200">
          <a 
            href={cta.href}
            class="flex items-center justify-center w-full py-3.5 bg-primary text-white font-semibold rounded-lg shadow-sm hover:bg-primary-600 hover:shadow-md transition-colors"
          >
            {cta.text}
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Region Indicator (if region is set) -->
  {options.showRegionIndicator && currentRegion && (
    <div class="bg-gradient-to-r from-accent from-opacity-10 to-accent to-opacity-5 border-b border-accent border-opacity-20" role="complementary" aria-label={aria.region_info}>
      <div class="container mx-auto px-4 py-3">
        <div class="flex items-center justify-center text-sm">
          <svg class="w-4 h-4 mr-2 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          <span class="ml-2 px-2 py-1 bg-accent bg-opacity-20 text-accent-dark font-medium rounded-full text-xs">
            {regionLabels[currentRegion]}
          </span>
        </div>
      </div>
    </div>
  )}
</header>

<!-- Enhanced Mobile Menu JavaScript -->
<script>
  // Mobile menu functionality
  document.addEventListener('DOMContentLoaded', function() {
    const menuTrigger = document.querySelector('[data-mobile-menu-trigger]');
    const mobileMenu = document.querySelector('[data-mobile-menu]');
    const menuItems = document.querySelectorAll('[data-mobile-menu-item]');
    
    if (menuTrigger && mobileMenu) {
      // Toggle mobile menu
      menuTrigger.addEventListener('click', function() {
        const isHidden = mobileMenu.classList.contains('hidden');
        
        if (isHidden) {
          mobileMenu.classList.remove('hidden');
          menuTrigger.setAttribute('aria-expanded', 'true');
          document.body.style.overflow = 'hidden'; // Prevenir scroll
          menuTrigger.classList.add('bg-neutral-100');
          // Change icon to X
          menuTrigger.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M6 18L18 6M6 6l12 12" />
            </svg>
          `;
        } else {
          mobileMenu.classList.add('hidden');
          menuTrigger.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = ''; // Restaurar scroll
          menuTrigger.classList.remove('bg-neutral-100');
          // Change icon back to hamburger
          menuTrigger.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          `;
        }
      });
      
      // Close menu when clicking on menu items
      menuItems.forEach(item => {
        item.addEventListener('click', function() {
          mobileMenu.classList.add('hidden');
          menuTrigger.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = ''; // Restaurar scroll
          menuTrigger.classList.remove('bg-neutral-100');
          menuTrigger.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          `;
        });
      });
      
      // Close menu on ESC key
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && !mobileMenu.classList.contains('hidden')) {
          mobileMenu.classList.add('hidden');
          menuTrigger.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = ''; // Restaurar scroll
          menuTrigger.classList.remove('bg-neutral-100');
          menuTrigger.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          `;
          (menuTrigger as HTMLElement).focus();
        }
      });
    }
  });
  
  // Enhanced smooth scrolling and active section detection
  document.addEventListener('DOMContentLoaded', function() {
    const anchorLinks = document.querySelectorAll('a[href^="#"]');
    const navItems = document.querySelectorAll('[data-nav-item]');
    const header = document.querySelector('header') as HTMLElement;
    const headerHeight = header ? header.offsetHeight : 80;
    
    // Smooth scrolling for anchor links
    anchorLinks.forEach(link => {
      link.addEventListener('click', function(e) {
        const targetId = (e.target as HTMLAnchorElement).getAttribute('href');
        const targetElement = targetId ? document.querySelector(targetId) : null;
        
        if (targetElement) {
          e.preventDefault();
          const targetPosition = (targetElement as HTMLElement).offsetTop - headerHeight - 20;
          window.scrollTo({
            top: targetPosition,
            behavior: 'smooth'
          });
        }
      });
    });
    
    // Active section detection
    function updateActiveNavItem() {
      const scrollPosition = window.scrollY + headerHeight + 100;
      const sections = document.querySelectorAll('section[id]');
      
      let activeSection = '';
      sections.forEach(section => {
        const sectionElement = section as HTMLElement;
        const sectionTop = sectionElement.offsetTop;
        const sectionHeight = sectionElement.offsetHeight;
        
        if (scrollPosition >= sectionTop && scrollPosition < sectionTop + sectionHeight) {
          activeSection = section.getAttribute('id') || '';
        }
      });
      
      // Update nav items
      navItems.forEach(item => {
        const href = item.getAttribute('href');
        if (href === `#${activeSection}`) {
          item.classList.add('nav-link--active');
        } else {
          item.classList.remove('nav-link--active');
        }
      });
    }
    
    // Throttled scroll listener
    let ticking = false;
    window.addEventListener('scroll', () => {
      if (!ticking) {
        requestAnimationFrame(() => {
          updateActiveNavItem();
          ticking = false;
        });
        ticking = true;
      }
    });
  });
</script>

<style>
  /* Enhanced Header Styles */
  header {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }
  
  /* Logo hover effect removido para una estética más sobria */
  
  /* Navigation enhanced styles - Corregido */
  .nav-link {
    position: relative;
    overflow: hidden;
    color: var(--color-neutral-800) !important;
    font-weight: 600;
    z-index: 1;
  }
  
  .nav-link:hover {
    color: var(--color-primary) !important;
    background-color: rgba(21, 101, 192, 0.1);
  }
  
  /* Estado activo del nav-link */
  .nav-link.nav-link--active {
    color: white !important;
    background-color: var(--color-primary) !important;
  }
  
  .nav-link.nav-link--active:hover {
    color: white !important;
    background-color: var(--color-primary-600, var(--color-primary)) !important;
  }
  
  .nav-link span {
    position: relative;
    z-index: 2;
    color: inherit;
  }
  
  .nav-link.nav-link--active span {
    color: white !important;
  }
  
  .mobile-nav-link {
    color: var(--color-neutral-800) !important;
    font-weight: 600;
  }
  
  .mobile-nav-link:hover {
    color: var(--color-primary) !important;
    background-color: rgba(21, 101, 192, 0.1);
  }
  
  .mobile-nav-link span {
    color: inherit;
  }
  
  /* Mobile menu animation mejorada */
  [data-mobile-menu] {
    animation: slideDownFade 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    transform-origin: top;
  }
  
  @keyframes slideDownFade {
    from {
      opacity: 0;
      transform: translateY(-20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }
  
  /* Shimmer gradiente removido para un CTA más corporativo */
  
  /* Header scroll effect */
  @media (min-width: 1024px) {
    header.scrolled {
      padding-top: 0.75rem;
      padding-bottom: 0.75rem;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
    }
  }
  
  /* Focus styles mejorados */
  button:focus-visible,
  a:focus-visible {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
    border-radius: 0.5rem;
  }
  
  /* Smooth transitions para todos los elementos interactivos */
  button, a, [data-nav-item] {
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  /* Language switcher hover effect */
  .bg-neutral-100 a:hover {
    transform: translateY(-1px);
  }
  
  /* Ensure text visibility - Override any conflicting styles */
  header nav a,
  header [data-nav-item],
  header .nav-link,
  header .mobile-nav-link {
    text-decoration: none !important;
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  header nav a span,
  header [data-nav-item] span,
  header .nav-link span,
  header .mobile-nav-link span {
    opacity: 1 !important;
    visibility: visible !important;
    color: inherit !important;
  }
  
  /* Brand text visibility */
  header h1,
  header p {
    opacity: 1 !important;
    visibility: visible !important;
  }
  
  /* Mobile menu text visibility */
  [data-mobile-menu] a,
  [data-mobile-menu] span {
    opacity: 1 !important;
    visibility: visible !important;
    color: inherit !important;
  }
</style>